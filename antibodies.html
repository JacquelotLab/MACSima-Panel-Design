<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lab Portal - Antibody Panels</title>
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    nav { background: #003366; padding: 10px; }
    nav a { color: white; margin: 0 15px; text-decoration: none; }
    nav a:hover { text-decoration: underline; }
    h1 { color: #003366; }
    table { width: 100%; }
    #cart { margin-top: 30px; padding: 15px; border: 2px solid #003366; border-radius: 8px; }
    #cart ul { list-style: none; padding: 0; }
    #cart li { margin: 5px 0; }
    button { padding: 8px 14px; margin-top: 10px; background: #003366; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0055aa; }
  </style>
</head>
<body>

<nav>
  <a href="index.html">Home</a>
  <a href="antibodies.html">Antibody Panels</a>
  <a href="contact.html">Contact</a>
</nav>

<h1>Antibody Panel Builder</h1>
<p>
  Browse and filter available antibodies below.  
  Select antibodies to add them to your panel. The total cost will update automatically.  
  Once done, you can <b>download your panel as a CSV file</b>.
</p>

<table id="antibodyTable" class="display">
  <thead>
    <tr>
      <th>Select</th>
      <th>Antigen</th>
      <th>Color</th>
      <th>Format</th>
      <th>Price (CAD)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="cart">
  <h3>Your Custom Panel</h3>
  <ul id="cartItems"></ul>
  <p>Total: $<span id="total">0</span> CAD</p>
  <button onclick="downloadCSV()">Download Panel (CSV)</button>
</div>

<!-- jQuery, DataTables, PapaParse -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
let table;
let selectedRows = [];

document.addEventListener("DOMContentLoaded", function () {
  table = $('#antibodyTable').DataTable();

  // 读取 CSV
  Papa.parse("antibodies.csv", {
    download: true,
    header: true,
    complete: function(results) {
      let data = results.data;
      data.forEach(row => {
        if (row.Antigen) { // 避免空行
          table.row.add([
            `<input type="checkbox" class="antibody-check"
              data-antigen="${row.Antigen}"
              data-color="${row.Color}"
              data-format="${row.Format}"
              data-price="${row.Price}">`,
            row.Antigen,
            row.Color,
            row.Format,
            row.Price
          ]).draw(false);
        }
      });
      $('#antibodyTable').on('change', '.antibody-check', updateCart);
    }
  });
});

function updateCart() {
  let cart = document.getElementById("cartItems");
  let total = 0;
  selectedRows = [];
  cart.innerHTML = "";

  document.querySelectorAll('.antibody-check:checked').forEach(cb => {
    let antigen = cb.getAttribute("data-antigen");
    let color = cb.getAttribute("data-color");
    let format = cb.getAttribute("data-format");
    let price = parseFloat(cb.getAttribute("data-price"));

    total += price;
    selectedRows.push({Antigen: antigen, Color: color, Format: format, Price: price});

    let li = document.createElement("li");
    li.innerText = `${antigen} | ${color} | ${format} | $${price}`;
    cart.appendChild(li);
  });

  document.getElementById("total").innerText = total;
}

function downloadCSV() {
  if (selectedRows.length === 0) {
    alert("Please select at least one antibody.");
    return;
  }

  // 生成 CSV 内容
  let csvContent = "data:text/csv;charset=utf-8,";
  csvContent += "Antigen,Color,Format,Price(CAD)\n";
  selectedRows.forEach(item => {
    csvContent += `${item.Antigen},${item.Color},${item.Format},${item.Price}\n`;
  });
  csvContent += `Total,,,${document.getElementById("total").innerText}\n`;

  // 下载文件
  let encodedUri = encodeURI(csvContent);
  let link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "My_Antibody_Panel.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>

</body>
</html>
