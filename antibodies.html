<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lab Portal - Antibody Panels</title>
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    nav { background: #003366; padding: 10px; }
    nav a { color: white; margin: 0 15px; text-decoration: none; }
    nav a:hover { text-decoration: underline; }
    h1 { color: #003366; }
    table { width: 100%; }
    #cart { margin-top: 30px; padding: 15px; border: 2px solid #003366; border-radius: 8px; }
    #cart ul { list-style: none; padding: 0; }
    #cart li { margin: 5px 0; }
    button { padding: 8px 14px; margin-top: 10px; background: #003366; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0055aa; }
  </style>
</head>
<body>

<nav>
  <a href="index.html">Home</a>
  <a href="antibodies.html">Antibody Panels</a>
  <a href="contact.html">Contact</a>
</nav>

<h1>Antibody Panel Builder</h1>
<p>
  Browse and filter available antibodies below.  
  Select antibodies to add them to your panel. The total cost will update automatically.  
  Once done, you can download your selection as a CSV file.
</p>

<div class="filters">
  <label>Filter by Color:
    <select id="colorFilter">
      <option value="">All</option>
    </select>
  </label>

  <label>Filter by Company:
    <select id="companyFilter">
      <option value="">All</option>
    </select>
  </label>
</div>
  
<table id="antibodyTable" class="display">
  <thead>
    <tr>
      <th>Select</th>
      <th>Markers</th>
      <th>Antibodies</th>
      <th>Clone</th>
      <th>Color</th>
      <th>Cat#</th>
      <th>Dilution</th>
      <th>Amount/Tests</th>
      <th>Price (CAD)</th>
      <th>Validated Fixation</th>
      <th>Company</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="cart">
  <h3>Your Custom Panel</h3>
  <ul id="cartItems"></ul>
  <p>Total: $<span id="total">0</span> CAD</p>
  <button onclick="downloadCSV()">Download Panel (CSV)</button>
</div>

<!-- jQuery, DataTables, PapaParse -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
let table;
let selectedRows = [];

document.addEventListener("DOMContentLoaded", function () {
  table = $('#antibodyTable').DataTable();

  // 读取 CSV
  Papa.parse("antibodies.csv", {
    download: true,
    header: true,
    complete: function(results) {
      let data = results.data;
      data.forEach(row => {
        if (row.Markers) { // 避免空行
          table.row.add([
            `<input type="checkbox" class="antibody-check"
              data-markers="${row.Markers}"
              data-antibodies="${row.Antibodies}"
              data-clone="${row.Clone}"
              data-color="${row.Color}"
              data-cat="${row["Cat#"]}"
              data-dilution="${row.Dilution}"
              data-amount="${row["Amount/Tests"]}"
              data-price="${row["Price (CAD)"]}"
              data-fixation="${row["Validated Fixation"]}"
              data-company="${row.Company}">`,
            row.Markers,
            row.Antibodies,
            row.Clone,
            row.Color,
            row["Cat#"],
            row.Dilution,
            row["Amount/Tests"],
            row["Price (CAD)"],
            row["Validated Fixation"],
            row.Company
          ]).draw(false);
        }
      });
      $('#antibodyTable').on('change', '.antibody-check', updateCart);
    }
  });
});

function updateCart() {
  let cart = document.getElementById("cartItems");
  let total = 0;
  selectedRows = [];
  cart.innerHTML = "";

  document.querySelectorAll('.antibody-check:checked').forEach(cb => {
    let row = {
      Markers: cb.getAttribute("data-markers"),
      Antibodies: cb.getAttribute("data-antibodies"),
      Clone: cb.getAttribute("data-clone"),
      Color: cb.getAttribute("data-color"),
      Cat: cb.getAttribute("data-cat"),
      Dilution: cb.getAttribute("data-dilution"),
      Amount: cb.getAttribute("data-amount"),
      Price: parseFloat(cb.getAttribute("data-price")),
      Fixation: cb.getAttribute("data-fixation"),
      Company: cb.getAttribute("data-company")
    };
    total += row.Price;
    selectedRows.push(row);

    let li = document.createElement("li");
    li.innerText = `${row.Markers} | ${row.Color} | $${row.Price}`;
    cart.appendChild(li);
  });

  document.getElementById("total").innerText = total;
}

function downloadCSV() {
  if (selectedRows.length === 0) {
    alert("Please select at least one antibody.");
    return;
  }

  let csvContent = "data:text/csv;charset=utf-8,";
  csvContent += "Markers,Antibodies,Clone,Color,Cat#,Dilution,Amount/Tests,Price (CAD),Validated Fixation,Company\n";
  selectedRows.forEach(item => {
    csvContent += `${item.Markers},${item.Antibodies},${item.Clone},${item.Color},${item.Cat},${item.Dilution},${item.Amount},${item.Price},${item.Fixation},${item.Company}\n`;
  });
  csvContent += `Total,,,,,,,,${document.getElementById("total").innerText}\n`;

  let encodedUri = encodeURI(csvContent);
  let link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "My_Antibody_Panel.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>

</body>
</html>
